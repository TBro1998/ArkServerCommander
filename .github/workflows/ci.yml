name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # å‰ç«¯æµ‹è¯•
  frontend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ui

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: ui/pnpm-lock.yaml

    - name: Install dependencies
      run: pnpm install

    - name: Build frontend
      run: pnpm build

    - name: Check build output
      run: |
        if [ ! -d ".output" ]; then
          echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼š.output ç›®å½•ä¸å­˜åœ¨"
          ls -la
          exit 1
        fi
        echo "ğŸ“ æ„å»ºç›®å½•ç»“æ„ï¼š"
        ls -la .output/
        if [ -d ".output/public" ]; then
          ls -la .output/public/
        fi
        
        # æ£€æŸ¥ SPA åº”ç”¨çš„ä¸»å…¥å£æ–‡ä»¶
        if [ ! -f ".output/public/index.html" ] && [ ! -f ".output/public/200.html" ]; then
          echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ° HTML å…¥å£æ–‡ä»¶"
          echo "ğŸ“ .output ç›®å½•å†…å®¹ï¼š"
          find .output -name "*.html" -o -name "*.js" | head -10
          exit 1
        fi
        echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"

  # åç«¯æµ‹è¯•
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        cache-dependency-path: server/go.sum

    - name: Install dependencies
      run: |
        go mod download
        go mod tidy

    - name: Run go fmt
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¿è¡Œ go fmt"
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… ä»£ç æ ¼å¼æ­£ç¡®"

    - name: Run go vet
      run: go vet ./...

    - name: Build backend
      run: go build -v ./...

    - name: Run tests
      run: go test -v ./... 