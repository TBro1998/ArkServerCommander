# é”™è¯¯æ¢å¤æœºåˆ¶å®ç°æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ ArkServerCommander é¡¹ç›®ä¸­å®ç°çš„é”™è¯¯æ¢å¤æœºåˆ¶ã€‚

## ğŸ¯ è§£å†³çš„é—®é¢˜

**é—®é¢˜ #1: ç¼ºå°‘é”™è¯¯æ¢å¤æœºåˆ¶**

- å®¹å™¨åˆ›å»ºå¤±è´¥æ—¶å¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼
- å­¤ç«‹çš„ Docker å·å ç”¨ç£ç›˜ç©ºé—´
- æ•°æ®åº“è®°å½•ä¸å®é™…èµ„æºä¸ä¸€è‡´
- ç«¯å£å†²çªå¯¼è‡´é‡å¤åˆ›å»ºå¤±è´¥

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### æ ¸å¿ƒç»„ä»¶

#### 1. RollbackManagerï¼ˆå›æ»šç®¡ç†å™¨ï¼‰

**æ–‡ä»¶**: `server/service/docker_manager/rollback.go`

**åŠŸèƒ½**:
- ç®¡ç†å›æ»šæ“ä½œé˜Ÿåˆ—
- é€†åºæ‰§è¡Œå›æ»šæ“ä½œ
- è®°å½•å›æ»šæ—¥å¿—

**ä½¿ç”¨ç¤ºä¾‹**:
```go
rollback := docker_manager.NewRollbackManager()

// æ·»åŠ å›æ»šæ“ä½œ
rollback.AddAction("volume", volumeName, "åˆ é™¤Dockerå·", func() error {
    return dockerManager.RemoveVolume(volumeName)
})

// å‘ç”Ÿé”™è¯¯æ—¶æ‰§è¡Œå›æ»š
if err != nil {
    rollback.Rollback()
}

// æˆåŠŸå®Œæˆæ—¶æ¸…ç©ºå›æ»šé˜Ÿåˆ—
rollback.Clear()
```

#### 2. CreateContainerWithRollbackï¼ˆå¸¦å›æ»šçš„å®¹å™¨åˆ›å»ºï¼‰

**æ–‡ä»¶**: `server/service/docker_manager/container_with_rollback.go`

**åŠŸèƒ½**:
- åˆ›å»ºå®¹å™¨æ—¶è‡ªåŠ¨æ³¨å†Œå›æ»šæ“ä½œ
- å¤±è´¥æ—¶è‡ªåŠ¨æ¸…ç†å·²åˆ›å»ºçš„å®¹å™¨
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

**æ”¹è¿›ç‚¹**:
- âœ… è‡ªåŠ¨æ¸…ç†å¤±è´¥çš„å®¹å™¨
- âœ… é˜²æ­¢èµ„æºæ³„æ¼
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

#### 3. CreateServerWithRollbackï¼ˆå¸¦å›æ»šçš„æœåŠ¡å™¨åˆ›å»ºï¼‰

**æ–‡ä»¶**: 
- `server/service/server/server_create_with_rollback.go`
- `server/service/server/server_create_continue.go`

**åŠŸèƒ½**:
- äº‹åŠ¡æ€§åˆ›å»ºæœåŠ¡å™¨
- å¤±è´¥æ—¶å›æ»šæ‰€æœ‰èµ„æºï¼ˆæ•°æ®åº“ã€å·ã€é…ç½®æ–‡ä»¶ï¼‰
- åˆ†æ­¥æ‰§è¡Œï¼Œæ¯æ­¥éƒ½æœ‰å›æ»šä¿æŠ¤

**å›æ»šé¡ºåº**:
1. åˆ é™¤é…ç½®æ–‡ä»¶ï¼ˆé€šè¿‡åˆ é™¤å·ï¼‰
2. åˆ é™¤ Docker å·
3. åˆ é™¤æ•°æ®åº“è®°å½•
4. å›æ»šæ•°æ®åº“äº‹åŠ¡

#### 4. startServerAsyncWithRollbackï¼ˆå¸¦å›æ»šçš„æœåŠ¡å™¨å¯åŠ¨ï¼‰

**æ–‡ä»¶**:
- `server/service/server/server_start_with_rollback.go`
- `server/service/server/server_start_continue.go`

**åŠŸèƒ½**:
- å¯åŠ¨å¤±è´¥æ—¶è‡ªåŠ¨æ¸…ç†
- åœæ­¢å·²å¯åŠ¨çš„å®¹å™¨
- åˆ é™¤åˆ›å»ºçš„å®¹å™¨
- æ›´æ–°æ•°æ®åº“çŠ¶æ€

## ğŸ“Š å·¥ä½œæµç¨‹

### åˆ›å»ºæœåŠ¡å™¨æµç¨‹

```
å¼€å§‹åˆ›å»ºæœåŠ¡å™¨
    â†“
æ£€æŸ¥æ ‡è¯†æ˜¯å¦å­˜åœ¨
    â†“
åˆ›å»ºæ•°æ®åº“äº‹åŠ¡ â† æ·»åŠ å›æ»šæ“ä½œ
    â†“
åˆ›å»ºæœåŠ¡å™¨è®°å½• â† æ·»åŠ å›æ»šæ“ä½œ
    â†“
åˆ›å»º Docker å· â† æ·»åŠ å›æ»šæ“ä½œ
    â†“
å†™å…¥é…ç½®æ–‡ä»¶
    â†“
æäº¤æ•°æ®åº“äº‹åŠ¡
    â†“
æˆåŠŸ â†’ æ¸…ç©ºå›æ»šé˜Ÿåˆ—
    â†“
å¤±è´¥ â†’ æ‰§è¡Œå›æ»šï¼ˆé€†åºï¼‰
```

### å¯åŠ¨æœåŠ¡å™¨æµç¨‹

```
å¼€å§‹å¯åŠ¨æœåŠ¡å™¨
    â†“
éªŒè¯é•œåƒå­˜åœ¨
    â†“
æ£€æŸ¥å®¹å™¨æ˜¯å¦éœ€è¦é‡å»º
    â†“
åˆ›å»ºå®¹å™¨ï¼ˆå¦‚éœ€è¦ï¼‰ â† æ·»åŠ å›æ»šæ“ä½œ
    â†“
å¯åŠ¨å®¹å™¨ â† æ·»åŠ å›æ»šæ“ä½œ
    â†“
ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆ30ç§’è¶…æ—¶ï¼‰
    â†“
æ›´æ–°æ•°æ®åº“çŠ¶æ€
    â†“
æˆåŠŸ â†’ æ¸…ç©ºå›æ»šé˜Ÿåˆ—
    â†“
å¤±è´¥ â†’ æ‰§è¡Œå›æ»šï¼ˆé€†åºï¼‰
```

## ğŸ§ª æµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `server/service/docker_manager/rollback_test.go`

**è¿è¡Œæµ‹è¯•**:
```bash
cd server/service/docker_manager
go test -v -run TestRollback
```

**æµ‹è¯•è¦†ç›–**:
- âœ… å•ä¸ªå›æ»šæ“ä½œ
- âœ… å¤šä¸ªå›æ»šæ“ä½œï¼ˆé€†åºæ‰§è¡Œï¼‰
- âœ… æ¸…ç©ºå›æ»šé˜Ÿåˆ—

## ğŸ“ ä½¿ç”¨æŒ‡å—

### åœ¨ç°æœ‰ä»£ç ä¸­ä½¿ç”¨

#### æ–¹å¼ 1: ä½¿ç”¨æ–°çš„å¸¦å›æ»šæ–¹æ³•

```go
// åˆ›å»ºæœåŠ¡å™¨
response, err := serverService.CreateServerWithRollback(userID, req)
if err != nil {
    // é”™è¯¯å·²è‡ªåŠ¨å›æ»š
    return err
}
```

#### æ–¹å¼ 2: åœ¨æ§åˆ¶å™¨ä¸­åˆ‡æ¢

ä¿®æ”¹ `server/controllers/servers/server.go`:

```go
// æ—§æ–¹æ³•
// response, err := serverService.CreateServer(userID, req)

// æ–°æ–¹æ³•ï¼ˆå¸¦å›æ»šï¼‰
response, err := serverService.CreateServerWithRollback(userID, req)
```

### è‡ªå®šä¹‰å›æ»šæ“ä½œ

```go
rollback := docker_manager.NewRollbackManager()

// æ·»åŠ è‡ªå®šä¹‰å›æ»šæ“ä½œ
rollback.AddAction("custom", "resource_id", "æè¿°", func() error {
    // ä½ çš„æ¸…ç†é€»è¾‘
    return nil
})

// æ‰§è¡Œæ“ä½œ
if err := doSomething(); err != nil {
    rollback.Rollback()
    return err
}

// æˆåŠŸåæ¸…ç©º
rollback.Clear()
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å›æ»šé¡ºåº**: å›æ»šæ“ä½œæŒ‰ç…§æ·»åŠ çš„é€†åºæ‰§è¡Œ
2. **å¹‚ç­‰æ€§**: å›æ»šæ“ä½œåº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼ˆå¯ä»¥å¤šæ¬¡æ‰§è¡Œï¼‰
3. **é”™è¯¯å¤„ç†**: å›æ»šå¤±è´¥ä¼šè®°å½•æ—¥å¿—ï¼Œä½†ä¸ä¼šä¸­æ–­å…¶ä»–å›æ»šæ“ä½œ
4. **èµ„æºæ¸…ç†**: ç¡®ä¿æ‰€æœ‰åˆ›å»ºçš„èµ„æºéƒ½æ³¨å†Œäº†å›æ»šæ“ä½œ

## ğŸ” æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸåˆ›å»ºæœåŠ¡å™¨

```
INFO  å¼€å§‹åˆ›å»ºæœåŠ¡å™¨ï¼ˆå¸¦å›æ»šä¿æŠ¤ï¼‰ identifier=my-server user_id=1
INFO  æœåŠ¡å™¨è®°å½•åˆ›å»ºæˆåŠŸ server_id=5
INFO  åˆ›å»ºDockerå· server_id=5
INFO  Dockerå·åˆ›å»ºæˆåŠŸ volume=ark-server-5
INFO  å†™å…¥GameUserSettings.ini server_id=5
INFO  å†™å…¥Game.ini server_id=5
INFO  æäº¤æ•°æ®åº“äº‹åŠ¡ server_id=5
INFO  æœåŠ¡å™¨åˆ›å»ºæˆåŠŸ server_id=5 identifier=my-server
```

### åˆ›å»ºå¤±è´¥å¹¶å›æ»š

```
INFO  å¼€å§‹åˆ›å»ºæœåŠ¡å™¨ï¼ˆå¸¦å›æ»šä¿æŠ¤ï¼‰ identifier=my-server user_id=1
INFO  æœåŠ¡å™¨è®°å½•åˆ›å»ºæˆåŠŸ server_id=5
INFO  åˆ›å»ºDockerå· server_id=5
ERROR åˆ›å»ºDockerå·å¤±è´¥: disk full
WARN  æœåŠ¡å™¨åˆ›å»ºå¤±è´¥ï¼Œå¼€å§‹æ‰§è¡Œå›æ»š error=åˆ›å»ºDockerå·å¤±è´¥
INFO  å¼€å§‹æ‰§è¡Œå›æ»šæ“ä½œ count=2
INFO  æ‰§è¡Œå›æ»š type=database resource=server_5 description=åˆ é™¤æœåŠ¡å™¨è®°å½•
INFO  å›æ»šæ“ä½œæˆåŠŸ type=database resource=server_5
INFO  æ‰§è¡Œå›æ»š type=database resource=transaction description=å›æ»šæ•°æ®åº“äº‹åŠ¡
INFO  å›æ»šæ“ä½œæˆåŠŸ type=database resource=transaction
INFO  æ‰€æœ‰å›æ»šæ“ä½œæ‰§è¡Œå®Œæˆ
```

## ğŸ“ˆ æ”¹è¿›æ•ˆæœ

### ä¹‹å‰çš„é—®é¢˜

- âŒ åˆ›å»ºå¤±è´¥åç•™ä¸‹å­¤ç«‹çš„ Docker å·
- âŒ æ•°æ®åº“è®°å½•ä¸å®é™…èµ„æºä¸ä¸€è‡´
- âŒ éœ€è¦æ‰‹åŠ¨æ¸…ç†å¤±è´¥çš„èµ„æº
- âŒ é‡å¤åˆ›å»ºå¯¼è‡´ç«¯å£å†²çª

### ç°åœ¨çš„æ”¹è¿›

- âœ… è‡ªåŠ¨æ¸…ç†æ‰€æœ‰å¤±è´¥çš„èµ„æº
- âœ… æ•°æ®åº“å’Œ Docker èµ„æºä¿æŒä¸€è‡´
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œå›æ»šæ—¥å¿—
- âœ… é˜²æ­¢èµ„æºæ³„æ¼

## ğŸš€ ä¸‹ä¸€æ­¥

1. åœ¨æ§åˆ¶å™¨ä¸­å¯ç”¨æ–°çš„å¸¦å›æ»šæ–¹æ³•
2. è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½
3. ç›‘æ§ç”Ÿäº§ç¯å¢ƒçš„å›æ»šæ—¥å¿—
4. æ ¹æ®å®é™…æƒ…å†µä¼˜åŒ–å›æ»šç­–ç•¥

---

**åˆ›å»ºæ—¥æœŸ**: 2026-02-01  
**ä½œè€…**: AI Agent (å‘œå‘¼)
