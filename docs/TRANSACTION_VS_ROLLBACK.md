# æ•°æ®åº“äº‹åŠ¡ vs æ‰‹åŠ¨å›æ»š - å¯¹æ¯”åˆ†æ

## ğŸ¤” ä½ çš„é—®é¢˜

> "å›æ»šæ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ˜¯ä¸æ˜¯æ›´å¥½"

**ç­”æ¡ˆï¼šæ˜¯çš„ï¼ä½ è¯´å¾—å¯¹ã€‚**

---

## ğŸ“Š ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ A: æ‰‹åŠ¨å›æ»šç®¡ç†å™¨ï¼ˆåŸå®ç°ï¼‰

```go
// åˆ›å»ºå›æ»šç®¡ç†å™¨
rollback := NewRollbackManager()

// å¼€å§‹äº‹åŠ¡
tx := database.DB.Begin()

// æ·»åŠ å›æ»šæ“ä½œ
rollback.AddAction("database", "transaction", "å›æ»šäº‹åŠ¡", func() error {
    tx.Rollback()
    return nil
})

// åˆ›å»ºè®°å½•
tx.Create(&server)

// æ·»åŠ å›æ»šæ“ä½œ
rollback.AddAction("database", "server", "åˆ é™¤è®°å½•", func() error {
    return database.DB.Unscoped().Delete(&server).Error
})

// æäº¤äº‹åŠ¡
tx.Commit()
```

**é—®é¢˜**:
- âŒ æ•°æ®åº“æ“ä½œå’Œå›æ»šé€»è¾‘åˆ†ç¦»
- âŒ éœ€è¦æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡å’Œå›æ»š
- âŒ å®¹æ˜“å‡ºé”™ï¼ˆå¿˜è®°æ·»åŠ å›æ»šæ“ä½œï¼‰
- âŒ å›æ»šé¡ºåºå¤æ‚

---

### æ–¹æ¡ˆ B: æ•°æ®åº“äº‹åŠ¡ + Docker å›æ»šï¼ˆæ”¹è¿›ç‰ˆï¼‰

```go
// Docker èµ„æºå›æ»šç®¡ç†å™¨
dockerRollback := NewRollbackManager()

// æ•°æ®åº“äº‹åŠ¡ï¼ˆGORM è‡ªåŠ¨å›æ»šï¼‰
err := database.DB.Transaction(func(tx *gorm.DB) error {
    // æ‰€æœ‰æ•°æ®åº“æ“ä½œ
    if err := tx.Create(&server).Error; err != nil {
        return err  // è‡ªåŠ¨å›æ»š
    }
    return nil  // è‡ªåŠ¨æäº¤
})

if err != nil {
    return nil, err  // æ•°æ®åº“å·²è‡ªåŠ¨å›æ»š
}

// åˆ›å»º Docker èµ„æº
volumeName, err := dockerManager.CreateVolume(server.ID)
if err != nil {
    database.DB.Unscoped().Delete(server)  // åˆ é™¤æ•°æ®åº“è®°å½•
    return nil, err
}

// æ³¨å†Œ Docker å›æ»š
dockerRollback.AddAction("volume", volumeName, "åˆ é™¤å·", func() error {
    return dockerManager.RemoveVolume(volumeName)
})
```

**ä¼˜ç‚¹**:
- âœ… æ•°æ®åº“æ“ä½œåŸå­æ€§ï¼ˆGORM è‡ªåŠ¨ç®¡ç†ï¼‰
- âœ… æ¸…æ™°åˆ†ç¦»ï¼šæ•°æ®åº“äº‹åŠ¡ vs Docker èµ„æº
- âœ… æ›´ç®€å•ã€æ›´å¯é 
- âœ… ç¬¦åˆæœ€ä½³å®è·µ

---

## ğŸ“ æ”¹è¿›è¦ç‚¹

### 1. æ•°æ®åº“æ“ä½œä½¿ç”¨äº‹åŠ¡

**åŸå› **:
- GORM çš„ `Transaction` æ–¹æ³•è‡ªåŠ¨å¤„ç†æäº¤/å›æ»š
- å‡ºé”™æ—¶è‡ªåŠ¨å›æ»šï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†
- ä»£ç æ›´ç®€æ´ã€æ›´å¯é 

### 2. Docker èµ„æºä½¿ç”¨å›æ»šç®¡ç†å™¨

**åŸå› **:
- Docker æ“ä½œä¸æ”¯æŒäº‹åŠ¡
- éœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼ˆåˆ é™¤å·ã€å®¹å™¨ç­‰ï¼‰
- RollbackManager é€‚åˆè¿™ç§åœºæ™¯

### 3. åˆ†ç¦»å…³æ³¨ç‚¹

**æ•°æ®åº“å±‚**:
- ä½¿ç”¨ GORM äº‹åŠ¡
- è‡ªåŠ¨å›æ»š

**Docker å±‚**:
- ä½¿ç”¨ RollbackManager
- æ‰‹åŠ¨æ¸…ç†

---

## ğŸ”„ å·¥ä½œæµç¨‹å¯¹æ¯”

### åŸå®ç°ï¼ˆæ··åˆå›æ»šï¼‰

```
å¼€å§‹
 â†“
åˆ›å»ºå›æ»šç®¡ç†å™¨
 â†“
å¼€å§‹æ•°æ®åº“äº‹åŠ¡ â†’ æ·»åŠ å›æ»šæ“ä½œ1
 â†“
åˆ›å»ºæ•°æ®åº“è®°å½• â†’ æ·»åŠ å›æ»šæ“ä½œ2
 â†“
åˆ›å»º Docker å· â†’ æ·»åŠ å›æ»šæ“ä½œ3
 â†“
å†™å…¥é…ç½®æ–‡ä»¶
 â†“
æäº¤æ•°æ®åº“äº‹åŠ¡
 â†“
å¤±è´¥ â†’ æ‰§è¡Œæ‰€æœ‰å›æ»šæ“ä½œï¼ˆé€†åºï¼‰
```

### æ”¹è¿›ç‰ˆï¼ˆåˆ†ç¦»å›æ»šï¼‰

```
å¼€å§‹
 â†“
æ•°æ®åº“äº‹åŠ¡ {
    åˆ›å»ºè®°å½•
    â†“
    å¤±è´¥ â†’ GORM è‡ªåŠ¨å›æ»š âœ…
    æˆåŠŸ â†’ GORM è‡ªåŠ¨æäº¤ âœ…
}
 â†“
åˆ›å»º Docker å· â†’ æ³¨å†Œå›æ»šæ“ä½œ
 â†“
å†™å…¥é…ç½®æ–‡ä»¶
 â†“
å¤±è´¥ â†’ æ¸…ç† Docker èµ„æº + åˆ é™¤æ•°æ®åº“è®°å½•
æˆåŠŸ â†’ æ¸…ç©ºå›æ»šé˜Ÿåˆ—
```

---

## ğŸ“‚ æ–°å¢æ–‡ä»¶

1. **`server_create_with_transaction.go`** - ä½¿ç”¨äº‹åŠ¡çš„åˆ›å»ºæ–¹æ³•
2. **`server_create_docker_resources.go`** - Docker èµ„æºåˆ›å»º

---

## ğŸ¯ æ€»ç»“

ä½ çš„å»ºè®®éå¸¸æ­£ç¡®ï¼

**æ”¹è¿›ç‚¹**:
1. âœ… æ•°æ®åº“æ“ä½œä½¿ç”¨ GORM äº‹åŠ¡ï¼ˆè‡ªåŠ¨å›æ»šï¼‰
2. âœ… Docker èµ„æºä½¿ç”¨ RollbackManagerï¼ˆæ‰‹åŠ¨æ¸…ç†ï¼‰
3. âœ… æ¸…æ™°åˆ†ç¦»å…³æ³¨ç‚¹
4. âœ… ä»£ç æ›´ç®€æ´ã€æ›´å¯é 

**æ¨èä½¿ç”¨**: `CreateServerWithTransaction` æ–¹æ³•

---

**æ—¥æœŸ**: 2026-02-01  
**æ”¹è¿›è€…**: TBro çš„å»ºè®® âœ¨
